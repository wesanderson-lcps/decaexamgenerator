<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DECA Practice Test Generator</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Import Map -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.344.0",
                "firebase/app": "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js"
            }
        }
    </script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Global PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .no-select { user-select: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Save, Trash2, Plus, Play, FileText, Settings, BarChart3, Upload, Check, AlertCircle, X, Download, Sparkles, Loader2, Database, Info, Target, List, BookOpen, GraduationCap, Zap, ChevronRight, Search, Filter, FileUp, FileArchive, Eye, Grid, PieChart, FileJson, Cloud, CloudOff, HardDrive, AlertTriangle, Lock, Flag, LogOut, LayoutGrid, Edit, XCircle, Timer } from 'lucide-react';
        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "firebase/auth";
        import { getFirestore, collection, doc, addDoc, deleteDoc, updateDoc, onSnapshot, writeBatch, orderBy, query } from "firebase/firestore";

        // ------------------------------------------------------------------
        // SYSTEM INITIALIZATION
        // ------------------------------------------------------------------
        
        // Manual Configuration provided by user
        const manualFirebaseConfig = {
            apiKey: "AIzaSyBjAuXLXvPOYyCrWe8oplahBWMsnASi6Qo",
            authDomain: "aidecaexams.firebaseapp.com",
            projectId: "aidecaexams",
            storageBucket: "aidecaexams.firebasestorage.app",
            messagingSenderId: "895592591782",
            appId: "1:895592591782:web:83ac6d77e3f6644c589f67",
            measurementId: "G-D849ZSZG5K"
        };

        const apiKey = "AIzaSyB4N7YofFyJ9VGpiZrXfbVCdWKxnhwEVTA"; // Google Gemini API Key

        let firebaseConfig = manualFirebaseConfig;
        let app, auth, db;
        let useCloud = false;
        let globalInitError = null;
        
        // Use environment appId if available, otherwise default
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'deca-app';

        try {
            // Prioritize the manual config for this implementation
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            useCloud = true;
        } catch (e) {
            console.error("Firebase Init Failed:", e);
            globalInitError = e.message;
            useCloud = false;
        }

        // --- DATA CONSTANTS ---
        const INSTRUCTIONAL_AREAS = {
            BL: "Business Law",
            CM: "Channel Management",
            CO: "Communications",
            CR: "Customer Relations",
            EC: "Economics",
            EI: "Emotional Intelligence",
            EN: "Entrepreneurship",
            FI: "Financial Analysis",
            FM: "Financial-Information Mgmt",
            HR: "Human Resources Mgmt",
            IM: "Information Management",
            MK: "Marketing",
            MP: "Market Planning",
            NF: "Marketing-Information Mgmt",
            OP: "Operations",
            PD: "Professional Development",
            PI: "Pricing",
            PJ: "Project Management",
            PM: "Product/Service Mgmt",
            PR: "Promotion",
            QM: "Quality Management",
            RM: "Risk Management",
            SE: "Selling",
            SM: "Strategic Management",
            PF_EI: "Earning Income (PFL)",
            PF_SP: "Spending (PFL)",
            PF_SA: "Saving (PFL)",
            PF_IN: "Investing (PFL)",
            PF_CR: "Managing Credit (PFL)",
            PF_MR: "Managing Risk (PFL)"
        };

        const DEFAULT_BLUEPRINTS = {
            "Finance": { BL: 7, CO: 5, CR: 5, EC: 6, EI: 9, EN: 1, FI: 24, FM: 9, HR: 1, IM: 6, MK: 1, OP: 6, PD: 13, RM: 6, SM: 1 },
            "Entrepreneurship": { BL: 4, CM: 3, CO: 1, CR: 1, EC: 3, EI: 6, EN: 14, FI: 10, HR: 5, IM: 4, MP: 5, MK: 1, NF: 2, OP: 13 },
            "Business Admin Core": { BL: 1, CO: 15, CR: 5, EC: 7, EI: 14, EN: 1, FI: 2, HR: 0, IM: 13, MK: 1, OP: 2, PD: 5 },
            "Marketing": { BL: 1, CM: 8, CO: 8, EC: 5, EI: 8, FI: 5, IM: 8, MP: 8, NF: 11, OP: 6, PI: 3, PM: 11, PD: 6, PR: 9, SE: 6, SM: 1 },
            "Hospitality": { BL: 2, CO: 8, CR: 10, EC: 5, EI: 8, FI: 5, HR: 5, IM: 8, OP: 10, PD: 5, PM: 5, SE: 5 },
            "Business Management": { BL: 4, CO: 10, CR: 5, EC: 5, EI: 10, FI: 5, HR: 8, IM: 8, OP: 8, PD: 8, PJ: 5, SM: 5 },
            "Personal Financial Literacy": { PF_EI: 15, PF_SP: 15, PF_SA: 15, PF_IN: 20, PF_CR: 15, PF_MR: 20 } 
        };

        const INITIAL_QUESTIONS = [
            {
                id: "q1",
                cluster: "Finance",
                category: "BL",
                pi: "Describe the nature of legally binding contracts",
                question: "Which of the following is a characteristic of a legally binding contract:",
                options: ["The contract must be written and signed.", "One of the parties must be in agreement.", "The contract must include an expiration date.", "Something of value must be exchanged."],
                answer: "D",
                rationale: "Something of value must be exchanged (Consideration) for a contract to be legally binding."
            },
            {
                id: "q2",
                cluster: "Business Admin Core",
                category: "PD", 
                pi: "PD:032 Describe techniques for obtaining work experience",
                question: "Entry-level positions provide employees with",
                options: ["high salaries.", "basic job experience.", "management training.", "stock options."],
                answer: "B",
                rationale: "Entry-level positions are starting jobs that allow new employees to gain basic experience."
            }
        ];

        // --- UTILS ---
        const cleanAndParseJSON = (text) => {
            if (!text) return [];
            console.log("Raw AI Response:", text); // Keep logging for debugging

            const tryParse = (str) => {
                try {
                    return JSON.parse(str);
                } catch (e) {
                    return null;
                }
            };

            // 1. Attempt to strip markdown code fences
            let clean = text.replace(/```json/gi, '').replace(/```/g, '').trim();
            let parsed = tryParse(clean);

            // 2. If that failed, look for the first '{' (Object) or '[' (Array)
            if (!parsed) {
                const firstBrace = text.indexOf('{');
                const firstBracket = text.indexOf('[');
                
                // Determine which comes first
                let startIdx = -1;
                let endChar = '';
                
                if (firstBrace !== -1 && (firstBracket === -1 || firstBrace < firstBracket)) {
                    startIdx = firstBrace;
                    endChar = '}';
                } else if (firstBracket !== -1) {
                    startIdx = firstBracket;
                    endChar = ']';
                }

                if (startIdx !== -1) {
                    const lastIdx = text.lastIndexOf(endChar);
                    if (lastIdx !== -1) {
                        parsed = tryParse(text.substring(startIdx, lastIdx + 1));
                    }
                }
            }

            if (!parsed) {
                console.error("JSON Parsing Failed completely.");
                return [];
            }

            // 3. Normalize to Array
            if (Array.isArray(parsed)) return parsed;
            if (typeof parsed === 'object' && parsed !== null) {
                if (Array.isArray(parsed.questions)) return parsed.questions;
                if (Array.isArray(parsed.items)) return parsed.items;
                
                // Fallback: search values for an array
                const vals = Object.values(parsed);
                const foundArr = vals.find(v => Array.isArray(v));
                if (foundArr) return foundArr;
            }

            return [];
        };

        // --- HELPER COMPONENTS ---

        function ExamSession({ exam, mode, setMode, userAnswers, setUserAnswers, currentIndex, setCurrentIndex, onExit, onSaveSubmission, studentName, examStartTime }) {
            const currentQ = exam[currentIndex];
            const [explanation, setExplanation] = useState(null);
            const [isExplaining, setIsExplaining] = useState(false);
            const [flagged, setFlagged] = useState(new Set());
            const [showReview, setShowReview] = useState(false);
            const [showCancelConfirm, setShowCancelConfirm] = useState(false);
            const [now, setNow] = useState(Date.now());

            useEffect(() => { setExplanation(null); }, [currentIndex]);

            // Timer Tick - Uses the persistent start time from parent prop
            useEffect(() => {
                if (mode !== 'taking') return;
                const timerId = setInterval(() => {
                    setNow(Date.now());
                }, 1000);
                return () => clearInterval(timerId);
            }, [mode]);

            // Calculate Time Left
            const duration = 90 * 60; // 90 minutes in seconds
            const elapsed = Math.floor((now - examStartTime) / 1000);
            const timeLeft = Math.max(0, duration - elapsed);

            // Auto-submit when time expires
            useEffect(() => {
                if (timeLeft === 0 && mode === 'taking') {
                    handleSubmit();
                }
            }, [timeLeft, mode]);

            const handleAnswer = (optIndex) => {
                if (mode === 'review') return;
                setUserAnswers(prev => ({ ...prev, [currentIndex]: ['A','B','C','D'][optIndex] }));
            };

            const toggleFlag = () => {
                const newFlags = new Set(flagged);
                if (newFlags.has(currentIndex)) newFlags.delete(currentIndex);
                else newFlags.add(currentIndex);
                setFlagged(newFlags);
            };

            const explainConcept = async () => {
                setIsExplaining(true);
                try {
                    // Changed model to gemini-1.5-flash for better compatibility
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Explain simply: ${currentQ.question} Answer: ${currentQ.answer}. Rationale: ${currentQ.rationale}` }] }] })
                    });
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message || "API Error");
                    }

                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    setExplanation(typeof text === 'string' ? text : "Could not load explanation.");
                } catch(e) { 
                    console.error(e); 
                    setExplanation(`Error: ${e.message}. (Check API Quota/Domain)`); 
                } finally { setIsExplaining(false); }
            };

            const downloadPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const score = Math.round((exam.filter((q, i) => userAnswers[i] === q.answer).length / exam.length) * 100);
                
                doc.setFontSize(20);
                doc.text("DECA Practice Test Results", 14, 20);
                
                doc.setFontSize(12);
                doc.text(`Student: ${studentName}`, 14, 30);
                doc.text(`Score: ${score}%`, 14, 36);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 42);
                
                const tableData = exam.map((q, i) => {
                    const userAnswer = userAnswers[i] || "Skipped";
                    const isCorrect = userAnswer === q.answer;
                    return [
                        i + 1,
                        isCorrect ? "Correct" : "Incorrect",
                        q.category,
                        q.question.substring(0, 50) + "...",
                        `You: ${userAnswer} | Key: ${q.answer}`,
                        q.rationale
                    ];
                });

                doc.autoTable({
                    startY: 50,
                    head: [['#', 'Status', 'Cat', 'Question', 'Answer', 'Rationale']],
                    body: tableData,
                    columnStyles: { 1: { fontStyle: 'bold' }, 5: { cellWidth: 50 } },
                    didParseCell: (data) => {
                        if (data.column.index === 1 && data.cell.raw === "Incorrect") data.cell.styles.textColor = [220, 53, 69];
                        else if (data.column.index === 1 && data.cell.raw === "Correct") data.cell.styles.textColor = [25, 135, 84];
                    }
                });

                doc.save(`${studentName.replace(/\s+/g,'_')}_deca_results.pdf`);
            };

            const handleSubmit = () => {
                const score = Math.round((exam.filter((q, i) => userAnswers[i] === q.answer).length / exam.length) * 100);
                onSaveSubmission({
                    studentName,
                    score,
                    date: new Date().toISOString(),
                    totalQuestions: exam.length,
                    correctCount: exam.filter((q, i) => userAnswers[i] === q.answer).length,
                    cluster: exam[0].cluster || "Mixed"
                });
                setMode('results');
            };

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m}:${s.toString().padStart(2, '0')}`;
            };

            const handleCancelClick = () => {
                setShowCancelConfirm(true);
            };

            const confirmExit = () => {
                setShowCancelConfirm(false);
                onExit(); // This function now fully clears the exam state in the parent
            };

            if (mode === 'results') {
                const score = Math.round((exam.filter((q, i) => userAnswers[i] === q.answer).length / exam.length) * 100);
                return (
                    <div className="p-8 text-center flex flex-col items-center justify-center h-full">
                        <div className="text-6xl font-bold text-blue-600 mb-4">{score}%</div>
                        <h2 className="text-2xl font-bold mb-6">Great Job, {studentName}!</h2>
                        <div className="flex gap-4 flex-wrap justify-center">
                            <button onClick={() => { setMode('review'); setCurrentIndex(0); }} className="px-6 py-2 border rounded hover:bg-slate-50">Review Answers</button>
                            <button onClick={downloadPDF} className="px-6 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-2"><Download size={18}/> Download PDF</button>
                            <button onClick={confirmExit} className="px-6 py-2 bg-slate-900 text-white rounded hover:bg-slate-800">Exit</button>
                        </div>
                    </div>
                );
            }

            if (showReview) {
                return (
                    <div className="h-full flex flex-col p-8 bg-slate-50">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold">Review Before Submitting</h2>
                            <button onClick={() => setShowReview(false)} className="px-4 py-2 border rounded hover:bg-white">Back to Exam</button>
                        </div>
                        <div className="flex-1 overflow-auto grid grid-cols-5 md:grid-cols-10 gap-3 content-start">
                            {exam.map((q, i) => {
                                const answered = userAnswers[i] !== undefined;
                                const isFlagged = flagged.has(i);
                                let bg = answered ? 'bg-blue-100 border-blue-300' : 'bg-white border-slate-300';
                                if (isFlagged) bg = 'bg-amber-100 border-amber-300 ring-2 ring-amber-400';
                                return (
                                    <button 
                                        key={i} 
                                        onClick={() => { setCurrentIndex(i); setShowReview(false); }}
                                        className={`p-3 rounded border text-sm font-bold ${bg} relative`}
                                    >
                                        {i + 1}
                                        {isFlagged && <Flag size={10} className="absolute top-1 right-1 text-amber-600 fill-amber-600"/>}
                                    </button>
                                )
                            })}
                        </div>
                        <div className="mt-6 border-t pt-4 flex justify-end">
                            <button onClick={handleSubmit} className="px-8 py-3 bg-green-600 text-white font-bold rounded shadow-lg hover:bg-green-700">Submit Final Exam</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-full w-full max-w-5xl mx-auto bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden relative">
                    
                    {showCancelConfirm && (
                        <div className="absolute inset-0 z-50 bg-slate-900/50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full border border-slate-200">
                                <h3 className="text-xl font-bold text-slate-800 mb-2">End Session?</h3>
                                <p className="text-slate-600 mb-6">Are you sure you want to cancel this session? All progress will be lost.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowCancelConfirm(false)} className="flex-1 px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 font-medium text-slate-700">No, Stay</button>
                                    <button onClick={confirmExit} className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold">Yes, Exit</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 1. Header (Fixed Height) */}
                    <div className="h-16 p-4 border-b flex justify-between items-center bg-white flex-shrink-0 z-10 sticky top-0">
                        <div className="flex items-center gap-4">
                            <div>
                                <span className="font-bold text-slate-700 text-lg">Question {currentIndex + 1} of {exam.length}</span>
                                <div className="text-xs text-slate-500 mt-1">{currentQ.category}</div>
                            </div>
                            
                            {mode === 'taking' && (
                                <div className={`flex items-center gap-2 px-3 py-1 rounded-full border font-mono font-bold text-sm ${timeLeft < 300 ? 'bg-red-50 text-red-600 border-red-200 animate-pulse' : 'bg-slate-100 text-slate-600 border-slate-200'}`}>
                                    <Timer size={14} />
                                    {formatTime(timeLeft)}
                                </div>
                            )}
                        </div>
                        <div className="flex items-center gap-3">
                            <button 
                                onClick={toggleFlag} 
                                className={`p-2 rounded border transition-colors ${flagged.has(currentIndex) ? 'bg-amber-100 border-amber-300 text-amber-700' : 'bg-white border-slate-200 text-slate-400'}`}
                                title="Flag for Review"
                            >
                                <Flag size={20} className={flagged.has(currentIndex) ? 'fill-amber-600' : ''}/>
                            </button>
                            <button onClick={handleCancelClick} className="text-red-500 hover:bg-red-50 p-2 rounded"><X size={24}/></button>
                        </div>
                    </div>

                    {/* 2. Content Area (Scrollable Middle) */}
                    <div className="flex-1 p-6 md:p-12 overflow-y-auto bg-slate-50 scroll-smooth">
                        <div className="max-w-3xl mx-auto pb-6">
                            <p className="text-xl mb-8 leading-relaxed font-medium text-slate-800 min-h-[80px]">{currentQ.question}</p>
                            
                            <div className="space-y-4">
                                {currentQ.options.map((opt, idx) => {
                                    const letter = ['A','B','C','D'][idx];
                                    const isSel = userAnswers[currentIndex] === letter;
                                    const isCor = currentQ.answer === letter;
                                    let cls = "w-full text-left p-5 rounded-lg border-2 flex gap-4 transition-all items-center group ";
                                    
                                    if (mode === 'review') {
                                        if (isCor) cls += "bg-green-100 border-green-500 text-green-900";
                                        else if (isSel) cls += "bg-red-50 border-red-300";
                                        else cls += "border-slate-200 opacity-60";
                                    } else {
                                        cls += isSel ? "bg-blue-50 border-blue-600 shadow-sm" : "bg-white border-slate-200 hover:border-blue-300 hover:bg-blue-50/50";
                                    }

                                    return (
                                        <button key={idx} onClick={() => mode !== 'review' && setUserAnswers(prev => ({...prev, [currentIndex]: letter}))} className={cls}>
                                            <span className={`w-8 h-8 flex items-center justify-center rounded-full text-sm font-bold border ${isSel || (mode === 'review' && isCor) ? 'bg-blue-600 text-white border-blue-600' : 'bg-slate-100 text-slate-500 border-slate-300 group-hover:border-blue-400'}`}>
                                                {letter}
                                            </span>
                                            <span className="text-base">{opt}</span>
                                        </button>
                                    );
                                })}
                            </div>

                            {mode === 'review' && (
                                <div className="mt-8 p-6 bg-white rounded-xl border border-slate-200 shadow-sm animate-in fade-in slide-in-from-bottom-4">
                                    <h4 className="font-bold text-slate-800 mb-2 flex items-center gap-2"><Info size={18}/> Rationale</h4>
                                    <p className="text-slate-600 leading-relaxed">{currentQ.rationale}</p>
                                    {!explanation ? (
                                        <button onClick={explainConcept} disabled={isExplaining} className="mt-4 text-purple-600 font-bold flex items-center gap-2 hover:bg-purple-50 px-4 py-2 rounded transition-colors text-sm border border-purple-200 w-full justify-center">
                                            {isExplaining ? <Loader2 size={16} className="animate-spin"/> : <Sparkles size={16}/>} 
                                            {isExplaining ? "AI Tutor is thinking..." : "Ask AI for a Simple Explanation"}
                                        </button>
                                    ) : (
                                        <div className="mt-4 text-sm text-purple-900 bg-purple-50 p-4 rounded-lg border border-purple-100 flex gap-3">
                                            <GraduationCap size={20} className="flex-shrink-0 mt-0.5 text-purple-600"/>
                                            <div>{explanation}</div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* 3. Footer (Fixed Height) */}
                    <div className="h-20 p-4 border-t bg-white flex justify-between items-center flex-shrink-0 z-10 sticky bottom-0">
                        <button 
                            onClick={() => setCurrentIndex(c => Math.max(0, c-1))} 
                            disabled={currentIndex===0} 
                            className="px-6 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 disabled:opacity-50 font-medium"
                        >
                            Previous
                        </button>
                        
                        {mode === 'taking' ? (
                            <button 
                                onClick={() => currentIndex === exam.length - 1 ? setShowReview(true) : setCurrentIndex(c => c+1)} 
                                className="px-8 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md transition-transform active:scale-95"
                            >
                                {currentIndex === exam.length - 1 ? 'Review & Submit' : 'Next Question'}
                            </button>
                        ) : (
                             <button onClick={confirmExit} className="px-8 py-2 bg-slate-800 text-white rounded-lg font-bold hover:bg-slate-900">Finish Review</button>
                        )}
                    </div>
                </div>
            );
        }

        function GeneratorTab({ clusters, selectedCluster, setSelectedCluster, examLength, setExamLength, onStartExam, questions, onAddQuestions, blueprints, storageMode, errorMsg }) {
            const [useAI, setUseAI] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);
            const [progress, setProgress] = useState("");
            const [studentName, setStudentName] = useState("");
            const [aiError, setAiError] = useState(null); // Track AI errors for UI

            const handleGenerate = async () => {
                if (!studentName.trim()) {
                    alert("Please enter your name to start the exam.");
                    return;
                }

                setIsGenerating(true);
                setAiError(null);
                const blueprint = blueprints[selectedCluster];
                if (!blueprint) return;

                const totalBlueprintCount = Object.values(blueprint).reduce((a, b) => a + b, 0);
                const scaleFactor = examLength / totalBlueprintCount;
                
                let finalExam = [];
                const poolByCategory = {};
                
                questions.forEach(q => {
                    if (q.cluster === selectedCluster || q.cluster === "Business Admin Core" || q.cluster === "AI Generated" || q.cluster === "Imported" || selectedCluster === "Personal Financial Literacy") {
                        if (!poolByCategory[q.category]) poolByCategory[q.category] = [];
                        poolByCategory[q.category].push(q);
                    }
                });

                const categories = Object.keys(blueprint);
                let newQuestionsAccumulator = [];

                for (const cat of categories) {
                    const targetCount = Math.round(blueprint[cat] * scaleFactor);
                    if (targetCount <= 0) continue;

                    const available = poolByCategory[cat] || [];
                    const shuffledAvailable = [...available].sort(() => 0.5 - Math.random());
                    const existingToUse = shuffledAvailable.slice(0, targetCount);
                    finalExam.push(...existingToUse);

                    const missingCount = targetCount - existingToUse.length;

                    if (missingCount > 0) {
                        if (useAI) {
                            setProgress(`Generating ${missingCount} questions for ${INSTRUCTIONAL_AREAS[cat]}...`);
                            try {
                                const prompt = `
                                    Generate ${missingCount} multiple-choice questions for DECA exam.
                                    Cluster: ${selectedCluster}
                                    Instructional Area: ${INSTRUCTIONAL_AREAS[cat]} (${cat}).
                                    Difficulty: High School Competition Level.
                                    Output MUST be a JSON Object with a "questions" key containing the list.
                                `;
                                
                                // Changed to stable model gemini-1.5-flash with safety settings AND Response Schema
                                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                                    method: 'POST', 
                                    headers: { 'Content-Type': 'application/json' }, 
                                    body: JSON.stringify({ 
                                        contents: [{ parts: [{ text: prompt }] }],
                                        generationConfig: { 
                                            responseMimeType: "application/json",
                                            responseSchema: {
                                                type: "OBJECT",
                                                properties: {
                                                    questions: {
                                                        type: "ARRAY",
                                                        items: {
                                                            type: "OBJECT",
                                                            properties: {
                                                                question: { type: "STRING" },
                                                                options: { type: "ARRAY", items: { type: "STRING" } },
                                                                answer: { type: "STRING" },
                                                                rationale: { type: "STRING" }
                                                            },
                                                            required: ["question", "options", "answer", "rationale"]
                                                        }
                                                    }
                                                }
                                            }
                                        },
                                        safetySettings: [
                                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                                        ]
                                    })
                                });

                                if (!response.ok) {
                                    const errData = await response.json();
                                    console.error("API Error Data:", errData);
                                    throw new Error(`${response.status}: ${errData.error?.message || response.statusText}`);
                                }

                                const data = await response.json();
                                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                                
                                if (!text) throw new Error("No text generated (Safety blocked?)");

                                const generated = cleanAndParseJSON(text);
                                
                                if (!generated || generated.length === 0) {
                                    console.warn("Parsed AI text was empty/invalid:", text);
                                    throw new Error("Invalid format received from AI");
                                }

                                const processedQuestions = generated.map(q => ({
                                    cluster: "AI Generated",
                                    category: cat,
                                    pi: "AI Generated based on Blueprint",
                                    question: q.question,
                                    options: q.options,
                                    answer: q.answer,
                                    rationale: q.rationale || "No rationale provided."
                                }));
                                newQuestionsAccumulator.push(...processedQuestions);
                                finalExam.push(...processedQuestions);
                                await new Promise(r => setTimeout(r, 2000)); // Increased delay to 2s to avoid 429
                            } catch (e) {
                                console.error(`Error generating questions for ${cat}:`, e);
                                setAiError(e.message); // Display exact error
                                // Fallback to placeholders
                                for(let i=0; i<missingCount; i++) finalExam.push(createPlaceholder(cat, selectedCluster, i));
                            }
                        } else {
                            for(let i=0; i<missingCount; i++) finalExam.push(createPlaceholder(cat, selectedCluster, i));
                        }
                    }
                }

                if (newQuestionsAccumulator.length > 0) {
                    await onAddQuestions(newQuestionsAccumulator);
                }

                finalExam = finalExam.sort(() => 0.5 - Math.random());
                if (finalExam.length > examLength) finalExam = finalExam.slice(0, examLength);
                while (finalExam.length < examLength) {
                    finalExam.push(createPlaceholder("SM", selectedCluster, 999));
                }

                setIsGenerating(false);
                onStartExam(finalExam, studentName);
            };

            const createPlaceholder = (cat, cluster, i) => ({
                id: `gap-${cat}-${Date.now()}-${i}`,
                cluster: cluster,
                category: cat,
                pi: "Blueprint Gap",
                question: `[Placeholder] Not enough questions in bank for ${INSTRUCTIONAL_AREAS[cat]}. Add more or enable AI Fill.`,
                options: ["A", "B", "C", "D"],
                answer: "A",
                rationale: "Placeholder."
            });

            return (
                <div className="p-8">
                    <h2 className="text-2xl font-bold mb-6 text-slate-800">Generate Practice Exam</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="space-y-6">
                             <div>
                                <label className="block text-sm font-medium text-slate-600 mb-2">Student Name</label>
                                <input 
                                    type="text" 
                                    value={studentName} 
                                    onChange={(e) => setStudentName(e.target.value)} 
                                    className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                    placeholder="Enter your full name"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-2">Select Cluster</label>
                                <select value={selectedCluster} onChange={(e) => setSelectedCluster(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    {Object.keys(blueprints).map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-2">Number of Questions</label>
                                <div className="grid grid-cols-3 gap-3">
                                    {[25, 50, 100].map(num => (
                                        <button key={num} onClick={() => setExamLength(num)} className={`py-3 rounded-lg border font-medium transition-all ${examLength === num ? 'bg-blue-50 border-blue-500 text-blue-700' : 'border-slate-200 hover:border-blue-300 text-slate-600'}`}>
                                            {num}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="p-4 bg-purple-50 border border-purple-100 rounded-xl">
                                <div className="flex items-center gap-3 mb-2">
                                    <input type="checkbox" id="useAI" checked={useAI} onChange={(e) => setUseAI(e.target.checked)} className="w-5 h-5 text-purple-600 rounded focus:ring-purple-500" />
                                    <label htmlFor="useAI" className="font-bold text-purple-900 cursor-pointer flex items-center gap-2"><Sparkles size={18}/> Magic AI Fill</label>
                                </div>
                                <p className="text-xs text-purple-700 ml-8">If checked, Gemini AI will automatically generate new questions to fill gaps in the selected cluster.</p>
                                
                                {aiError && (
                                    <div className="mt-2 p-3 bg-red-100 text-red-700 text-xs rounded border border-red-200 whitespace-pre-wrap">
                                        <strong>Generation Failed:</strong> {aiError}
                                        <br/><em>Note: 429 = Slow down (Rate Limit). 403 = Domain blocked.</em>
                                        <br/>Questions will default to placeholders.
                                    </div>
                                )}
                            </div>

                            <div className="pt-4">
                                <button 
                                    onClick={handleGenerate} 
                                    disabled={isGenerating || !studentName.trim()}
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
                                >
                                    {isGenerating ? <Loader2 className="animate-spin" /> : <Play size={20} />} 
                                    {isGenerating ? "Building Exam..." : "Start Exam"}
                                </button>
                                {isGenerating && <p className="text-center text-xs text-slate-500 mt-2 animate-pulse">{progress}</p>}
                            </div>
                        </div>
                        <div className="bg-slate-50 p-6 rounded-xl border border-slate-100 h-fit">
                            <h3 className="font-semibold text-slate-700 mb-4 flex items-center gap-2">
                                {storageMode === 'cloud' ? <Cloud size={18} className="text-green-600"/> : <HardDrive size={18} className="text-amber-600"/>} 
                                {storageMode === 'cloud' ? "Cloud Connected" : "Offline Mode"}
                            </h3>
                            <div className="space-y-3 text-sm text-slate-600">
                                <div className="flex justify-between p-2 bg-white rounded border border-slate-200"><span>Total Questions:</span> <span className="font-mono font-bold">{questions.length}</span></div>
                                <div className="flex justify-between p-2 bg-white rounded border border-slate-200"><span>Cluster:</span> <span className="font-bold text-blue-600 truncate max-w-[150px]">{selectedCluster}</span></div>
                                
                                {errorMsg ? (
                                    <div className="mt-4 p-3 border border-red-200 bg-red-50 rounded text-xs text-red-700">
                                        <div className="font-bold flex items-center gap-2 mb-1"><AlertTriangle size={14}/> Connection Error</div>
                                        {errorMsg}
                                    </div>
                                ) : (
                                    <div className={`mt-4 p-3 border rounded text-xs flex items-start gap-2 ${storageMode === 'cloud' ? 'bg-blue-50 border-blue-100 text-blue-800' : 'bg-amber-50 border-amber-100 text-amber-800'}`}>
                                        <Info size={14} className="flex-shrink-0 mt-0.5" />
                                        <span>{storageMode === 'cloud' ? "Connected to Cloud." : "Questions saved locally."}</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function BlueprintsTab({ blueprints, setBlueprints, isAdmin }) {
            const [editingCluster, setEditingCluster] = useState(Object.keys(blueprints)[0]);
            const handleUpdate = (cat, val) => {
                setBlueprints(prev => ({
                    ...prev, [editingCluster]: { ...prev[editingCluster], [cat]: parseInt(val) || 0 }
                }));
            };
            const currentBlueprint = blueprints[editingCluster];

            return (
                <div className="p-6 h-[calc(100vh-100px)] flex flex-col">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-slate-800">Exam Blueprints</h2>
                        <select value={editingCluster} onChange={(e) => setEditingCluster(e.target.value)} className="p-2 border rounded-lg text-sm">
                            {Object.keys(blueprints).map(b => <option key={b} value={b}>{b}</option>)}
                        </select>
                    </div>
                    <div className="flex-1 overflow-auto pr-2">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {Object.keys(currentBlueprint).sort().map(code => (
                                <div key={code} className={`flex items-center justify-between p-3 bg-slate-50 border border-slate-200 rounded-lg ${currentBlueprint[code] === 0 ? 'opacity-50' : ''}`}>
                                    <div className="flex flex-col"><span className="font-medium text-slate-700 text-sm">{INSTRUCTIONAL_AREAS[code] || code}</span><span className="text-xs text-slate-400 font-mono">{code}</span></div>
                                    {isAdmin ? (
                                        <input type="number" value={currentBlueprint[code]} onChange={(e) => handleUpdate(code, e.target.value)} className="w-16 p-2 text-right border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" />
                                    ) : (
                                        <span className="w-16 p-2 text-right font-bold text-slate-600">{currentBlueprint[code]}</span>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function QuestionBankTab({ questions, onAddQuestions, onDeleteQuestion, onDeleteAll, onEditQuestion, isAdmin }) {
            const [mode, setMode] = useState('list'); 
            const [viewFormat, setViewFormat] = useState('list');
            const [importText, setImportText] = useState("");
            const fileInputRef = useRef(null);
            const [notification, setNotification] = useState(null);
            const [selectedQuestion, setSelectedQuestion] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [filterCategory, setFilterCategory] = useState("ALL");
            const [importCategory, setImportCategory] = useState("SM");
            const [aiCategory, setAiCategory] = useState("BL");
            const [aiCount, setAiCount] = useState(5);
            const [isGenerating, setIsGenerating] = useState(false);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [deleteConfirmText, setDeleteConfirmText] = useState("");
            
            // Editing State
            const [isEditing, setIsEditing] = useState(false);
            const [editForm, setEditForm] = useState(null);

            useEffect(() => {
                if (notification) {
                    const timer = setTimeout(() => setNotification(null), 3000);
                    return () => clearTimeout(timer);
                }
            }, [notification]);

            const categoryCounts = useMemo(() => {
                const counts = {};
                Object.keys(INSTRUCTIONAL_AREAS).forEach(key => counts[key] = 0);
                questions.forEach(q => {
                    if (counts[q.category] !== undefined) counts[q.category]++;
                    else {
                        if (!counts['Other']) counts['Other'] = 0;
                        counts['Other']++;
                    }
                });
                return counts;
            }, [questions]);

            const loadJSZip = () => {
                return new Promise((resolve, reject) => {
                    if (window.JSZip) { resolve(window.JSZip); return; }
                    const script = document.createElement('script');
                    script.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
                    script.onload = () => resolve(window.JSZip);
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            };

            const processImportText = async (text) => {
                try {
                    const newQuestions = [];
                    const trimmedText = text.trim();
                    if (trimmedText.startsWith("<?xml") || trimmedText.includes("<POOL>")) {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(text, "text/xml");
                        const qNodes = xmlDoc.getElementsByTagName("QUESTION");
                        Array.from(qNodes).forEach(qNode => {
                            const bodyNode = qNode.getElementsByTagName("BODY")[0];
                            let qText = "";
                            if (bodyNode) {
                                const textNodes = bodyNode.getElementsByTagName("TEXT");
                                if(textNodes.length > 0) qText = textNodes[0].textContent;
                                else qText = bodyNode.textContent;
                            }
                            qText = qText.replace(/<[^>]*>/g, "").trim();
                            const answers = [];
                            const ansNodes = qNode.getElementsByTagName("ANSWER");
                            Array.from(ansNodes).forEach(aNode => {
                                let aText = "";
                                const textNodes = aNode.getElementsByTagName("TEXT");
                                if(textNodes.length > 0) aText = textNodes[0].textContent;
                                else aText = aNode.textContent;
                                aText = aText.replace(/<[^>]*>/g, "").trim();
                                if(aText) answers.push(aText);
                            });
                            if (qText && answers.length >= 2) {
                                newQuestions.push({
                                    cluster: "Imported",
                                    category: importCategory, 
                                    pi: "Imported from Blackboard/Zip",
                                    question: qText,
                                    options: answers.slice(0,4),
                                    answer: "A", 
                                    rationale: "Imported from file."
                                });
                            }
                        });
                    } else if (trimmedText.startsWith("[") && trimmedText.endsWith("]")) {
                        try {
                            const jsonData = JSON.parse(trimmedText);
                            if (Array.isArray(jsonData)) newQuestions.push(...jsonData);
                        } catch(e) { console.error("Not a valid JSON backup"); }
                    } else {
                        const lines = text.split('\n');
                        let currentQ = {};
                        let state = 'start'; 
                        lines.forEach(line => {
                            line = line.trim();
                            if(!line) return;
                            const qStart = line.match(/^(\d+)\.\s+(.*)/);
                            const optStart = line.match(/^([A-D])\.\s+(.*)/);
                            const keyLine = line.match(/^SOURCE:\s*([A-Z]{2}):/i);
                            if (qStart || (state !== 'opt' && !optStart && !keyLine)) {
                                if (currentQ.question && currentQ.options && currentQ.options.length >= 2) {
                                    newQuestions.push(currentQ);
                                }
                                currentQ = {
                                    cluster: "Imported",
                                    category: importCategory,
                                    question: qStart ? qStart[2] : line,
                                    options: [],
                                    answer: "A",
                                    rationale: "Imported."
                                };
                                state = 'q';
                            } else if (optStart && currentQ.question) {
                                state = 'opt';
                                currentQ.options.push(optStart[2]);
                            } else if (keyLine && currentQ.question) {
                                currentQ.category = keyLine[1].toUpperCase();
                                currentQ.pi = line.replace("SOURCE:", "").trim();
                            }
                        });
                        if (currentQ.question && currentQ.options && currentQ.options.length >= 2) {
                            newQuestions.push(currentQ);
                        }
                    }

                    if (newQuestions.length > 0) {
                        await onAddQuestions(newQuestions);
                        setNotification({ type: 'success', msg: `Successfully imported ${newQuestions.length} questions.` });
                        setImportText("");
                        setMode('list');
                    } else {
                        setNotification({ type: 'error', msg: "No valid questions found." });
                    }
                } catch (e) {
                    setNotification({ type: 'error', msg: "Import parsing failed." });
                }
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.name.endsWith('.zip')) {
                    try {
                        const JSZip = await loadJSZip();
                        const zip = await new JSZip().loadAsync(file);
                        const datFileName = Object.keys(zip.files).find(name => name.endsWith('.dat') && name.includes('res'));
                        if (datFileName) {
                            const text = await zip.file(datFileName).async("string");
                            setImportText(text.slice(0, 500) + "..."); 
                            processImportText(text);
                        } else {
                            setNotification({ type: 'error', msg: "No .dat file found in ZIP." });
                        }
                    } catch (err) {
                        setNotification({ type: 'error', msg: "Failed to read ZIP file." });
                    }
                } else {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const text = evt.target.result;
                        setImportText(text.slice(0, 500) + "..."); 
                        processImportText(text);
                    };
                    reader.readAsText(file);
                }
            };

            const handleDownloadBank = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(questions, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "deca_question_bank.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const handleAIGenerate = async () => {
                setIsGenerating(true);
                try {
                    const prompt = `Generate ${aiCount} multiple-choice questions for DECA exam. Category: ${aiCategory}. JSON Format: [{"question":"...","options":["A","B","C","D"],"answer":"A","rationale":"..."}]. Do not use markdown.`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                    });
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message || "API Error");
                    }

                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    const parsed = cleanAndParseJSON(text);
                    const generated = parsed.map(q => ({
                        cluster: "AI Generated", category: aiCategory, pi: "Ad-hoc AI",
                        question: q.question, options: q.options, answer: q.answer, rationale: q.rationale || "No rationale provided."
                    }));
                    await onAddQuestions(generated);
                    setNotification({ type: 'success', msg: `Generated and Saved ${generated.length} questions.` });
                    setMode('list');
                } catch(e) { 
                    console.error(e); 
                    setNotification({ type: 'error', msg: `AI Error: ${e.message}` });
                } finally { setIsGenerating(false); }
            };

            const handleFilterSelect = (e) => {
                setFilterCategory(e.target.value);
            };

            // --- Editing Logic ---
            const startEdit = (q) => {
                setEditForm({ ...q });
                setIsEditing(true);
                setSelectedQuestion(null); // Close view modal if open
            };

            const saveEdit = async () => {
                if (editForm) {
                    await onEditQuestion(editForm);
                    setIsEditing(false);
                    setEditForm(null);
                    setNotification({ type: 'success', msg: 'Question updated.' });
                }
            }

            const filteredQuestions = questions.filter(q => {
                const matchesSearch = q.question.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesCategory = filterCategory === "ALL" || q.category === filterCategory;
                return matchesSearch && matchesCategory;
            });

            return (
                <div className="p-6 h-[calc(100vh-100px)] flex flex-col relative">
                    {notification && (
                        <div className={`absolute top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 font-bold ${notification.type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
                        {notification.type === 'success' ? <Check size={18}/> : <AlertCircle size={18}/>} {notification.msg}
                        </div>
                    )}

                    {showDeleteConfirm && (
                        <div className="absolute inset-0 z-50 bg-slate-900/50 flex items-center justify-center p-4">
                            <div className="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full border border-red-100">
                                <h3 className="text-xl font-bold text-red-600 mb-2">Danger Zone</h3>
                                <p className="text-slate-600 mb-4 text-sm">Type "DELETE" to confirm clearing {questions.length} questions from the cloud database.</p>
                                <input type="text" value={deleteConfirmText} onChange={(e) => setDeleteConfirmText(e.target.value)} className="w-full p-2 border mb-4"/>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowDeleteConfirm(false)} className="flex-1 py-2 border rounded">Cancel</button>
                                    <button onClick={() => { if(deleteConfirmText === "DELETE") { onDeleteAll(); setShowDeleteConfirm(false); } }} disabled={deleteConfirmText !== "DELETE"} className="flex-1 py-2 bg-red-600 text-white rounded disabled:opacity-50">Delete All</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* EDIT MODAL */}
                    {isEditing && editForm && (
                        <div className="absolute inset-0 z-50 bg-slate-900/50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white p-8 rounded-xl shadow-2xl max-w-2xl w-full border border-slate-200 flex flex-col max-h-[90vh] overflow-y-auto">
                                <h3 className="text-xl font-bold mb-4">Edit Question</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Question Text</label>
                                        <textarea 
                                            value={editForm.question} 
                                            onChange={e => setEditForm({...editForm, question: e.target.value})}
                                            className="w-full p-2 border rounded h-24"
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        {editForm.options.map((opt, i) => (
                                            <div key={i}>
                                                <label className="text-xs font-bold text-slate-500">Option {['A','B','C','D'][i]}</label>
                                                <input 
                                                    value={opt}
                                                    onChange={e => {
                                                        const newOpts = [...editForm.options];
                                                        newOpts[i] = e.target.value;
                                                        setEditForm({...editForm, options: newOpts});
                                                    }}
                                                    className="w-full p-2 border rounded"
                                                />
                                            </div>
                                        ))}
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Correct Answer</label>
                                        <select 
                                            value={editForm.answer}
                                            onChange={e => setEditForm({...editForm, answer: e.target.value})}
                                            className="w-full p-2 border rounded"
                                        >
                                            {['A','B','C','D'].map(l => <option key={l} value={l}>{l}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Rationale</label>
                                        <textarea 
                                            value={editForm.rationale}
                                            onChange={e => setEditForm({...editForm, rationale: e.target.value})}
                                            className="w-full p-2 border rounded h-20"
                                        />
                                    </div>
                                    <div className="flex justify-end gap-2 pt-4">
                                        <button onClick={() => setIsEditing(false)} className="px-4 py-2 border rounded">Cancel</button>
                                        <button onClick={saveEdit} className="px-4 py-2 bg-blue-600 text-white rounded font-bold">Save Changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {selectedQuestion && (
                        <div className="absolute inset-0 z-50 bg-slate-900/50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white p-8 rounded-xl shadow-2xl max-w-2xl w-full border border-slate-200 flex flex-col max-h-[80vh]">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <span className="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs font-bold rounded mb-2">{selectedQuestion.category}</span>
                                        <h3 className="text-lg font-bold text-slate-900">{selectedQuestion.pi || "General Question"}</h3>
                                    </div>
                                    <div className="flex gap-2">
                                        {isAdmin && (
                                            <button onClick={() => startEdit(selectedQuestion)} className="text-blue-500 hover:text-blue-700 bg-blue-50 p-2 rounded">Edit</button>
                                        )}
                                        <button onClick={() => setSelectedQuestion(null)} className="text-slate-400 hover:text-slate-600"><X size={20}/></button>
                                    </div>
                                </div>
                                <div className="overflow-y-auto flex-1 pr-2">
                                    <p className="text-lg text-slate-800 mb-6 font-medium">{selectedQuestion.question}</p>
                                    <div className="space-y-2 mb-6">
                                        {selectedQuestion.options.map((opt, i) => {
                                            const letter = ['A','B','C','D'][i];
                                            const isCorrect = selectedQuestion.answer === letter;
                                            return (
                                                <div key={i} className={`p-3 rounded border flex items-center gap-3 ${isCorrect ? 'bg-green-50 border-green-500 text-green-900' : 'bg-slate-50 border-slate-200 text-slate-600'}`}>
                                                    <span className={`w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${isCorrect ? 'bg-green-200' : 'bg-slate-200'}`}>{letter}</span>
                                                    {opt}
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                        <h4 className="font-bold text-blue-800 text-sm mb-1">Rationale</h4>
                                        <p className="text-blue-700 text-sm">{selectedQuestion.rationale}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-slate-800">Question Bank</h2>
                        <div className="flex gap-2">
                        {questions.length === 0 && (
                            <button onClick={() => onAddQuestions(INITIAL_QUESTIONS)} className="flex items-center gap-2 px-3 py-2 bg-green-50 text-green-600 border border-green-200 rounded hover:bg-green-100"><Database size={16}/> Seed Sample Data</button>
                        )}
                        <button onClick={handleDownloadBank} className="flex items-center gap-2 px-3 py-2 bg-blue-50 text-blue-600 border border-blue-200 rounded hover:bg-blue-100" title="Save Bank to JSON File"><Download size={16}/> <span className="hidden md:inline">Backup</span></button>
                        {isAdmin && (
                             <button onClick={() => setShowDeleteConfirm(true)} className="flex items-center gap-2 px-3 py-2 bg-red-50 text-red-600 border border-red-200 rounded hover:bg-red-100"><Trash2 size={16}/></button>
                        )}
                        {/* Only show Bank access to Admins OR if not in exam mode */}
                        {(isAdmin || true) && ( 
                            <>
                                <button onClick={() => setMode('import')} className={`flex items-center gap-2 px-4 py-2 rounded font-medium ${mode === 'import' ? 'bg-blue-600 text-white' : 'bg-blue-50 text-blue-700'}`}><Plus size={16}/> Import</button>
                                <button onClick={() => setMode('ai')} className={`flex items-center gap-2 px-4 py-2 rounded font-medium ${mode === 'ai' ? 'bg-purple-600 text-white' : 'bg-purple-50 text-purple-700'}`}><Sparkles size={16}/> AI Add</button>
                                <button onClick={() => setMode('list')} className={`flex items-center gap-2 px-4 py-2 rounded font-medium ${mode === 'list' ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-700'}`}><List size={16}/> View List</button>
                            </>
                        )}
                        </div>
                    </div>

                    {mode === 'import' && (
                        <div className="flex-1 flex flex-col gap-4">
                            <div className="bg-amber-50 border border-amber-200 p-4 rounded-lg text-sm text-amber-800">
                                <strong>Import Options:</strong> 
                                <ul className="list-disc list-inside mt-2">
                                <li>Upload a <strong>ZIP</strong> (Blackboard format)</li>
                                <li>Upload a <strong>JSON</strong> backup file</li>
                                <li>Paste text directly from a <strong>PDF</strong></li>
                                </ul>
                            </div>
                            <div className="bg-white p-4 border rounded-lg">
                                <label className="block text-xs font-bold text-slate-500 mb-1">Default Category (if missing in file)</label>
                                <select value={importCategory} onChange={e => setImportCategory(e.target.value)} className="w-full p-2 border rounded">{Object.keys(INSTRUCTIONAL_AREAS).map(k => <option key={k} value={k}>{k}</option>)}</select>
                            </div>
                            <div className="flex gap-2">
                                <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" accept=".zip,.txt,.dat,.xml,.json"/>
                                <button onClick={() => fileInputRef.current.click()} className="px-4 py-2 bg-blue-100 text-blue-700 rounded border border-blue-200 hover:bg-blue-200 flex items-center gap-2"><FileArchive size={18}/> Upload File</button>
                            </div>
                            <textarea className="flex-1 w-full p-4 border rounded-lg font-mono text-xs" placeholder="Or paste text..." value={importText} onChange={e => setImportText(e.target.value)}/>
                            <button onClick={() => processImportText(importText)} className="w-full py-3 bg-slate-800 text-white rounded font-bold">Process Text</button>
                        </div>
                    )}

                    {mode === 'ai' && (
                        <div className="flex-1 flex flex-col items-center justify-center bg-purple-50 p-8 rounded-lg">
                            <div className="bg-white p-6 rounded-xl shadow-sm w-full max-w-md space-y-4">
                                <h3 className="font-bold text-purple-800">Quick AI Add</h3>
                                <select value={aiCategory} onChange={e => setAiCategory(e.target.value)} className="w-full p-2 border rounded">{Object.keys(INSTRUCTIONAL_AREAS).map(k => <option key={k} value={k}>{k}</option>)}</select>
                                <select value={aiCount} onChange={e => setAiCount(Number(e.target.value))} className="w-full p-2 border rounded"><option value="1">1 Question</option><option value="5">5 Questions</option><option value="10">10 Questions</option></select>
                                <button onClick={handleAIGenerate} disabled={isGenerating} className="w-full py-2 bg-purple-600 text-white rounded font-bold">{isGenerating ? "Generating..." : "Generate"}</button>
                            </div>
                        </div>
                    )}

                    {mode === 'list' && (
                        <div className="flex-1 overflow-auto">
                            {/* Question Counts Dashboard - UPDATED TO BE CLICKABLE */}
                            <div className="mb-6 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                                {Object.entries(INSTRUCTIONAL_AREAS).map(([code, name]) => {
                                const count = categoryCounts[code] || 0;
                                let bgColor = "bg-slate-100 border-slate-200 hover:bg-slate-200";
                                let textColor = "text-slate-500";
                                
                                if (count === 0) {
                                    // Empty
                                } else if (count < 5) {
                                    bgColor = "bg-amber-50 border-amber-200 hover:bg-amber-100";
                                    textColor = "text-amber-700";
                                } else {
                                    bgColor = "bg-green-50 border-green-200 hover:bg-green-100";
                                    textColor = "text-green-700";
                                }
                                
                                if (filterCategory === code) {
                                    bgColor = "bg-blue-100 border-blue-300 ring-2 ring-blue-400";
                                    textColor = "text-blue-900";
                                }

                                return (
                                    <div 
                                        key={code} 
                                        onClick={() => setFilterCategory(code === filterCategory ? "ALL" : code)}
                                        className={`border rounded-lg p-2 flex flex-col items-center justify-center cursor-pointer transition-all ${bgColor}`}
                                    >
                                    <span className={`text-xl font-bold ${textColor}`}>{count}</span>
                                    <span className="text-xs text-slate-500 font-medium">{code}</span>
                                    </div>
                                );
                                })}
                            </div>

                            <div className="flex flex-col md:flex-row gap-2 mb-4">
                                <input type="text" placeholder="Search..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="flex-1 p-2 border rounded"/>
                                <select value={filterCategory} onChange={handleFilterSelect} className="p-2 border rounded w-full md:w-48"><option value="ALL">All Categories</option>{Object.keys(INSTRUCTIONAL_AREAS).map(k => <option key={k} value={k}>{k}</option>)}</select>
                                <button onClick={() => setViewFormat(viewFormat === 'list' ? 'grid' : 'list')} className="p-2 border rounded bg-white hover:bg-slate-50 text-slate-600" title="Toggle View">
                                {viewFormat === 'list' ? <Grid size={20}/> : <List size={20}/>}
                                </button>
                            </div>
                            
                            {viewFormat === 'list' ? (
                                <table className="w-full text-left border-collapse">
                                    <thead><tr className="bg-slate-100 text-sm"><th className="p-3">Cat</th><th className="p-3">Question</th><th className="p-3 text-right">Action</th></tr></thead>
                                    <tbody>
                                    {filteredQuestions.map(q => (
                                        <tr key={q.id} className="border-b text-sm hover:bg-slate-50">
                                        <td className="p-3 font-bold text-blue-600">{q.category}</td>
                                        <td className="p-3 max-w-xs truncate cursor-pointer" onClick={() => setSelectedQuestion(q)}>{q.question}</td>
                                        <td className="p-3 text-right">
                                            <button onClick={() => setSelectedQuestion(q)} className="text-slate-400 hover:text-blue-600 mr-2"><Eye size={16}/></button>
                                            {isAdmin && <button onClick={() => onDeleteQuestion(q.id)} className="text-red-500 hover:text-red-700"><Trash2 size={16}/></button>}
                                        </td>
                                        </tr>
                                    ))}
                                    </tbody>
                                </table>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {filteredQuestions.map(q => (
                                        <div key={q.id} className="bg-white border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer relative group" onClick={() => setSelectedQuestion(q)}>
                                            <div className="flex justify-between items-start mb-2">
                                                <span className="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded">{q.category}</span>
                                                {isAdmin && (
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); onDeleteQuestion(q.id); }} 
                                                    className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                >
                                                    <Trash2 size={16}/>
                                                </button>
                                                )}
                                            </div>
                                            <p className="text-sm text-slate-800 line-clamp-3 mb-2 font-medium">{q.question}</p>
                                            <p className="text-xs text-slate-400 truncate">{q.pi || "No PI assigned"}</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // --- ADMIN DASHBOARD ---
        function AdminDashboard({ submissions, questions, onAddQuestions, onDeleteQuestion, onDeleteAll, onEditQuestion, isAdmin }) {
            const [filterDate, setFilterDate] = useState('all');
            const [activeSubTab, setActiveSubTab] = useState('submissions');

            const filteredSubs = submissions.filter(sub => {
                if (filterDate === 'today') {
                    return new Date(sub.date).toDateString() === new Date().toDateString();
                }
                return true;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));

            return (
                <div className="p-8 h-full flex flex-col">
                    <h2 className="text-2xl font-bold mb-6 text-slate-800 flex items-center gap-2"><Lock className="text-red-600" size={24}/> Admin Portal</h2>
                    
                    <div className="flex gap-4 mb-4 border-b">
                        <button 
                            onClick={() => setActiveSubTab('submissions')}
                            className={`pb-2 px-4 font-medium transition-colors ${activeSubTab === 'submissions' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-slate-800'}`}
                        >
                            Student Results
                        </button>
                        <button 
                            onClick={() => setActiveSubTab('questions')}
                            className={`pb-2 px-4 font-medium transition-colors ${activeSubTab === 'questions' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-slate-800'}`}
                        >
                            Question Bank Management
                        </button>
                    </div>

                    <div className="bg-white border border-slate-200 rounded-xl shadow-sm mb-6 flex-1 overflow-hidden flex flex-col">
                        {activeSubTab === 'submissions' ? (
                            <div className="p-6 flex-1 overflow-auto">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg">Student Submissions</h3>
                                    <select value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className="p-2 border rounded">
                                        <option value="all">All Time</option>
                                        <option value="today">Today Only</option>
                                    </select>
                                </div>
                                
                                <table className="w-full text-left">
                                    <thead className="bg-slate-50 text-sm font-bold text-slate-600 border-b">
                                        <tr>
                                            <th className="p-3">Date</th>
                                            <th className="p-3">Student Name</th>
                                            <th className="p-3">Cluster</th>
                                            <th className="p-3">Score</th>
                                            <th className="p-3">Details</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-sm">
                                        {filteredSubs.length === 0 ? <tr><td colSpan="5" className="p-6 text-center text-slate-400">No submissions found.</td></tr> : 
                                         filteredSubs.map((sub, i) => (
                                            <tr key={i} className="border-b hover:bg-slate-50">
                                                <td className="p-3">{new Date(sub.date).toLocaleString()}</td>
                                                <td className="p-3 font-medium text-slate-800">{sub.studentName}</td>
                                                <td className="p-3">{sub.cluster}</td>
                                                <td className="p-3 font-bold text-blue-600">{sub.score}%</td>
                                                <td className="p-3 text-slate-500">{sub.correctCount}/{sub.totalQuestions}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <QuestionBankTab 
                                questions={questions} 
                                onAddQuestions={onAddQuestions}
                                onDeleteQuestion={onDeleteQuestion}
                                onDeleteAll={onDeleteAll}
                                onEditQuestion={onEditQuestion}
                                isAdmin={isAdmin}
                            />
                        )}
                    </div>
                </div>
            );
        }

        // --- MAIN APP ---

        function DECATestGenerator() {
            const [activeTab, setActiveTab] = useState('generate'); 
            const [user, setUser] = useState(null);
            const [questions, setQuestions] = useState([]); 
            const [submissions, setSubmissions] = useState([]);
            const [blueprints, setBlueprints] = useState(DEFAULT_BLUEPRINTS);
            const [storageMode, setStorageMode] = useState('local');
            const [errorMsg, setErrorMsg] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [studentName, setStudentName] = useState("");
            
            // Exam State
            const [selectedCluster, setSelectedCluster] = useState("Finance");
            const [examLength, setExamLength] = useState(100);
            const [generatedExam, setGeneratedExam] = useState(null);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [userAnswers, setUserAnswers] = useState({});
            const [examMode, setExamMode] = useState('taking');
            const [examStartTime, setExamStartTime] = useState(null); // Track absolute start time
            
            // 1. Auth Effect (Run ONCE)
            useEffect(() => {
                const initAuth = async () => {
                    if (useCloud && auth) {
                        try {
                            // Using manual config requires anonymous auth as custom tokens won't match
                            await signInAnonymously(auth);
                        } catch (e) {
                            // SPECIFIC FIX FOR REFERER BLOCKED
                            if (e.message && e.message.includes('requests-from-referer')) {
                                console.warn("Firebase Domain Restriction: Cloud features disabled in this environment.");
                                setErrorMsg("Cloud sync disabled (Domain Restricted). App working in Offline Mode.");
                            } else {
                                console.error("Auth Failed", e);
                                setErrorMsg("Authentication failed. Using offline mode.");
                            }
                            setStorageMode('local');
                        }
                    }
                };
                initAuth();
                
                if (useCloud && auth) {
                    const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
                    return () => unsubscribe();
                }
            }, []);

            // 2. Data Fetching Effect (Dependent on User)
            useEffect(() => {
                let unsubQuestions = () => {};
                let unsubSubmissions = () => {};

                const fetchData = async () => {
                    if (useCloud && user) {
                        setStorageMode('cloud');
                        try {
                            // Questions
                            const qRef = collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                            unsubQuestions = onSnapshot(qRef, (snapshot) => {
                                const loadedQuestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                setQuestions(loadedQuestions);
                            }, (error) => {
                                console.error("Questions fetch error", error);
                                setStorageMode('local');
                            });

                            // Submissions
                            const sRef = collection(db, 'artifacts', appId, 'public', 'data', 'submissions');
                            unsubSubmissions = onSnapshot(sRef, (snapshot) => {
                                const subs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                setSubmissions(subs);
                            }, (error) => console.error("Subs fetch error", error));

                        } catch (e) {
                            console.error("Setup listeners failed", e);
                            setStorageMode('local');
                            loadLocalData();
                        }
                    } else if (!useCloud) {
                        setStorageMode('local');
                        loadLocalData();
                    }
                };

                fetchData();

                return () => {
                    unsubQuestions();
                    unsubSubmissions();
                };
            }, [user]); // Re-run when user changes

            const loadLocalData = () => {
                const localQ = localStorage.getItem('deca_questions');
                if (localQ) setQuestions(JSON.parse(localQ));
                
                const localS = localStorage.getItem('deca_submissions');
                if (localS) setSubmissions(JSON.parse(localS));
            };

            // 3. Local Storage Sync
            useEffect(() => {
                localStorage.setItem('deca_blueprints', JSON.stringify(blueprints));
                if (storageMode === 'local') {
                    localStorage.setItem('deca_questions', JSON.stringify(questions));
                    localStorage.setItem('deca_submissions', JSON.stringify(submissions));
                }
            }, [blueprints, questions, submissions, storageMode]);


            // HANDLERS
            const handleAddQuestions = async (newQuestions) => {
                if (storageMode === 'cloud' && user) {
                    const qRef = collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                    const batchSize = 450; 
                    for (let i = 0; i < newQuestions.length; i += batchSize) {
                        const chunk = newQuestions.slice(i, i + batchSize);
                        const batch = writeBatch(db);
                        chunk.forEach(q => {
                            const newDocRef = doc(qRef); 
                            const { id, ...qData } = q; 
                            // Sanitize
                            const cleanData = {};
                            Object.keys(qData).forEach(key => cleanData[key] = qData[key] === undefined ? "N/A" : qData[key]);
                            cleanData.options = cleanData.options.map(o => o ?? "");
                            batch.set(newDocRef, cleanData);
                        });
                        await batch.commit();
                    }
                } else {
                    const newWithIds = newQuestions.map(q => ({...q, id: `local-${Date.now()}-${Math.random()}`}));
                    setQuestions(prev => [...prev, ...newWithIds]);
                }
            };

            const handleDeleteQuestion = async (id) => {
                if (!isAdmin) return; // Guard
                if (storageMode === 'cloud' && user) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'questions', id));
                } else {
                    setQuestions(prev => prev.filter(q => q.id !== id));
                }
            };

            const handleEditQuestion = async (updatedQ) => {
                if (!isAdmin) return;
                if (storageMode === 'cloud' && user) {
                    const { id, ...data } = updatedQ;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'questions', id), data);
                } else {
                    setQuestions(prev => prev.map(q => q.id === updatedQ.id ? updatedQ : q));
                }
            };

            const handleDeleteAll = async () => {
                if (!isAdmin) return;
                if (storageMode === 'cloud' && user) {
                    const qRef = collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                    const batchSize = 450;
                    for (let i = 0; i < questions.length; i += batchSize) {
                        const chunk = questions.slice(i, i + batchSize);
                        const batch = writeBatch(db);
                        chunk.forEach(q => { batch.delete(doc(qRef, q.id)); });
                        await batch.commit();
                    }
                } else {
                    setQuestions([]);
                }
            };

            const handleSaveSubmission = async (subData) => {
                if (storageMode === 'cloud' && user) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'), subData);
                } else {
                    setSubmissions(prev => [subData, ...prev]);
                }
            };

            const toggleAdmin = () => {
                if (isAdmin) {
                    setIsAdmin(false);
                    setActiveTab('generate');
                } else {
                    const pass = prompt("Enter Admin Password:");
                    // CHANGE PASSWORD HERE: Replace "admin" with your desired password
                    if (pass === "admin") {
                        setIsAdmin(true);
                        setActiveTab('admin');
                    } else {
                        alert("Incorrect Password");
                    }
                }
            };

            const renderContent = () => {
                switch (activeTab) {
                    case 'blueprints': return <BlueprintsTab blueprints={blueprints} setBlueprints={setBlueprints} isAdmin={isAdmin} />;
                    case 'admin': return (
                        <AdminDashboard 
                            submissions={submissions}
                            questions={questions}
                            onAddQuestions={handleAddQuestions}
                            onDeleteQuestion={handleDeleteQuestion}
                            onDeleteAll={handleDeleteAll}
                            onEditQuestion={handleEditQuestion}
                            isAdmin={isAdmin}
                        />
                    );
                    case 'generate': return (
                        <GeneratorTab 
                            clusters={Object.keys(blueprints)} 
                            selectedCluster={selectedCluster} 
                            setSelectedCluster={setSelectedCluster}
                            examLength={examLength}
                            setExamLength={setExamLength}
                            questions={questions}
                            onAddQuestions={handleAddQuestions}
                            blueprints={blueprints}
                            storageMode={storageMode}
                            errorMsg={errorMsg}
                            onStartExam={(exam, name) => {
                                setGeneratedExam(exam);
                                setStudentName(name);
                                setExamMode('taking');
                                setUserAnswers({});
                                setCurrentQuestionIndex(0);
                                setExamStartTime(Date.now()); // Set absolute start time
                                setActiveTab('exam');
                            }}
                        />
                    );
                    case 'exam': return generatedExam ? (
                        <ExamSession 
                            exam={generatedExam} 
                            mode={examMode} 
                            setMode={setExamMode}
                            userAnswers={userAnswers}
                            setUserAnswers={setUserAnswers}
                            currentIndex={currentQuestionIndex}
                            setCurrentIndex={setCurrentQuestionIndex}
                            studentName={studentName}
                            examStartTime={examStartTime} // Pass persistent time
                            onSaveSubmission={handleSaveSubmission}
                            onExit={() => {
                                setGeneratedExam(null); // Reset exam state fully
                                setUserAnswers({});
                                setCurrentQuestionIndex(0);
                                setExamMode('taking');
                                setExamStartTime(null); // Kill the timer
                                setActiveTab('generate');
                            }}
                        />
                    ) : <div className="p-8 text-center text-gray-500">No exam generated yet.</div>;
                    default: return null;
                }
            };

            return (
                <div className="h-full bg-slate-50 text-slate-900 font-sans flex flex-col md:flex-row">
                    <nav className="w-full md:w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col justify-between">
                        <div>
                            <div className="p-6">
                                <h1 className="text-xl font-bold flex items-center gap-2">
                                    <BarChart3 className="text-blue-400" />
                                    DECA Prep
                                </h1>
                                <p className="text-xs text-slate-400 mt-1">Exam Generator & Bank</p>
                            </div>
                            <ul className="space-y-1 px-3">
                                {[
                                    { id: 'generate', label: 'Generate Test', icon: Play },
                                    { id: 'exam', label: 'Current Session', icon: FileText, disabled: !generatedExam },
                                    { id: 'blueprints', label: 'Exam Blueprints', icon: Settings },
                                    ...(isAdmin ? [{ id: 'admin', label: 'Admin Portal', icon: Lock }] : [])
                                ].map(item => (
                                    <li key={item.id}>
                                        <button
                                            disabled={item.disabled}
                                            onClick={() => setActiveTab(item.id)}
                                            className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${
                                                activeTab === item.id 
                                                    ? 'bg-blue-600 text-white' 
                                                    : item.disabled ? 'text-slate-600 cursor-not-allowed' : 'text-slate-300 hover:bg-slate-800'
                                            }`}
                                        >
                                            <item.icon size={18} />
                                            {item.label}
                                        </button>
                                    </li>
                                ))}
                            </ul>
                        </div>
                        <div className="p-4 border-t border-slate-700">
                             <button onClick={toggleAdmin} className="flex items-center gap-2 text-xs text-slate-400 hover:text-white transition-colors w-full">
                                {isAdmin ? <LogOut size={14}/> : <Lock size={14}/>}
                                {isAdmin ? "Logout Admin" : "Admin Login"}
                             </button>
                        </div>
                    </nav>

                    <main className="flex-1 overflow-auto p-4 md:p-8">
                        <div className="max-w-6xl mx-auto bg-white shadow-sm border border-slate-200 rounded-xl min-h-[600px] flex flex-col">
                            {renderContent()}
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<DECATestGenerator />);
    </script>
</body>
</html>
